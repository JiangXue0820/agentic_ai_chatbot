tasks:
  - title: "ğŸ” Verify Agent Refactor Completion & Runtime Health"
    description: |
      æ£€æŸ¥ app/agent ä¸‹çš„æ‰€æœ‰æ¨¡å—æ˜¯å¦å®Œæˆäº†å…­é˜¶æ®µé‡æ„è¦æ±‚ï¼Œå¹¶éªŒè¯ Agent æ˜¯å¦èƒ½æ­£å¸¸è¿è¡Œã€‚

      === æ£€æŸ¥ç‚¹ ===
      1ï¸âƒ£ config.py ä¸­å®šä¹‰äº†æ­£ç¡®çš„è·¯å¾„å¸¸é‡ï¼š
          - STORAGE_DIR
          - SESSION_MEM_PATH
          - LONGTERM_PATH
          - KNOWLEDGE_PATH

      2ï¸âƒ£ memory å±‚å®Œæ•´ï¼š
          - app/agent/memory.py å«æœ‰ to_longterm_snapshot() ä¸ clear()
          - SQLiteStore ä¸ VectorStore å¯¼å…¥è·¯å¾„æ­£ç¡®
          - ç›®å½• storage/memory/sessionMem å¯å†™å…¥

      3ï¸âƒ£ intent æ¨¡å—å·²å¢å¼ºï¼š
          - Intent dataclass å«æœ‰ source å±æ€§
          - Clarification è¿”å›åŒ…å« type, message, options, intents, steps å­—æ®µ
          - _fallback_recognition() ä¿ç•™åŸºç¡€åŒ¹é…é€»è¾‘

      4ï¸âƒ£ core æ¨¡å—é€»è¾‘ä¿®å¤ï¼š
          - _plan_and_execute() clarification è¿”å›åŒ…å« steps ä¸ intents
          - round_count æ¯ä¸ª intent é‡ç½®
          - timestamp ä½¿ç”¨ datetime.now().isoformat()
          - _normalize_output() å‡½æ•°å­˜åœ¨å¹¶ç”¨äº handle() ç»“å°¾
          - _fallback_planning() å‚æ•° key ä¸º city è€Œé location

      5ï¸âƒ£ summarization æ”¹è¿›ï¼š
          - _format_observation() è¾“å‡ºè‡ªç„¶è¯­è¨€æè¿°
          - _summarize_result() æ ¹æ®è¯­è¨€åˆ‡æ¢ promptï¼ˆå«ä¸­æ–‡/è‹±æ–‡é€»è¾‘ï¼‰

      6ï¸âƒ£ è·¨ session è®°å¿†å·²å¯ç”¨ï¼š
          - handle() è°ƒç”¨ long_mem.search()
          - handle() ç»“æŸæ—¶è°ƒç”¨ long_mem.store_conversation()

      7ï¸âƒ£ è¿è¡Œæ£€æŸ¥ï¼š
          - python -m app.agent.core å¯æˆåŠŸ import
          - åˆå§‹åŒ– Agent() ä¸æŠ¥é”™
          - è°ƒç”¨ Agent.handle("demo", "ä»Šå¤©å¤©æ°”å¦‚ä½•ï¼Ÿ") å¯è¿”å›ç»“æ„åŒ–ç»“æœ:
              { "type": "answer", "answer": "...", "intents": [...], "steps": [...] }

      === æ‰§è¡Œæ–¹å¼ ===
      1. æ£€æŸ¥æ–‡ä»¶å­˜åœ¨ä¸å…³é”®å‡½æ•°å®šä¹‰
      2. å°è¯• import app.agent.core å¹¶è¿è¡Œæœ€å°æµ‹è¯•
      3. è¾“å‡ºæ£€æµ‹æŠ¥å‘Šï¼ˆæ¨¡å—çŠ¶æ€ + Agent è¿è¡ŒçŠ¶æ€ï¼‰

    command: |
      echo "=== ğŸ” æ£€æŸ¥ Agent æ¨¡å—ç»“æ„ä¸åŠŸèƒ½çŠ¶æ€ ==="

      echo "â¡ï¸ æ£€æŸ¥é…ç½®è·¯å¾„..."
      grep -q "SESSION_MEM_PATH" app/utils/config.py && echo "âœ… config.py è·¯å¾„å·²å®šä¹‰" || echo "âŒ config.py ç¼ºå°‘è·¯å¾„å®šä¹‰"

      echo "â¡ï¸ æ£€æŸ¥ Memory å±‚..."
      test -f app/agent/memory.py && grep -q "to_longterm_snapshot" app/agent/memory.py && echo "âœ… memory.py å¢å¼ºå­˜åœ¨" || echo "âŒ memory.py æœªå®ç° snapshot"
      test -f app/agent/long_term_memory.py && grep -q "store_conversation" app/agent/long_term_memory.py && echo "âœ… long_term_memory å®ç°å­˜åœ¨" || echo "âŒ long_term_memory ç¼ºå¤±"
      test -d storage/memory/sessionMem && echo "âœ… SQLite å­˜å‚¨ç›®å½•å­˜åœ¨" || echo "âš ï¸ storage/memory/sessionMem æœªåˆ›å»º"

      echo "â¡ï¸ æ£€æŸ¥ Intent æ¨¡å—..."
      grep -q "source" app/agent/intent.py && echo "âœ… Intent.source å­˜åœ¨" || echo "âŒ Intent.source ç¼ºå¤±"
      grep -q "clarification" app/agent/intent.py && echo "âœ… Clarification ç»“æ„åŒ…å«" || echo "âŒ Clarification é€»è¾‘æœªæ›´æ–°"

      echo "â¡ï¸ æ£€æŸ¥ Core æ¨¡å—å…³é”®é€»è¾‘..."
      grep -q "_normalize_output" app/agent/core.py && echo "âœ… normalize_output å­˜åœ¨" || echo "âŒ normalize_output æœªå®šä¹‰"
      grep -q "round_count = 0" app/agent/core.py && echo "âœ… round_count é‡ç½®é€»è¾‘å­˜åœ¨" || echo "âš ï¸ round_count æœªé‡ç½®"
      grep -q "datetime.now().isoformat" app/agent/core.py && echo "âœ… æ—¶é—´æˆ³æ ¼å¼ä¿®æ­£" || echo "âš ï¸ æ—¶é—´æˆ³ä»ä¸ºæ—§æ ¼å¼"
      grep -q "city" app/agent/core.py && echo "âœ… fallback å‚æ•°å·²æ›´æ–°" || echo "âš ï¸ fallback ä»ä½¿ç”¨ location"

      echo "â¡ï¸ æ£€æŸ¥ Summarization æ”¹è¿›..."
      grep -q "æˆ‘æ‰¾åˆ°äº†" app/agent/core.py && echo "âœ… è‡ªç„¶è¯­è¨€ observation" || echo "âš ï¸ observation ä»ä¸ºåŸå§‹ç»“æ„"
      grep -q "Chinese" app/agent/core.py && echo "âœ… Summarizer è¯­è¨€æ£€æµ‹å­˜åœ¨" || echo "âš ï¸ Summarizer æœªæ£€æµ‹è¯­è¨€"

      echo "â¡ï¸ æ£€æŸ¥è·¨ Session è®°å¿†..."
      grep -q "long_mem.search" app/agent/core.py && grep -q "long_mem.store_conversation" app/agent/core.py && echo "âœ… longterm è®°å¿†é›†æˆ" || echo "âš ï¸ longterm æœªå¯ç”¨"

      echo "â¡ï¸ æ£€æŸ¥è¿è¡ŒçŠ¶æ€..."
      python3 - <<'EOF'
import sys, json
try:
    from app.agent.core import Agent
    agent = Agent()
    result = agent.handle("demo_user", "ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ")
    assert isinstance(result, dict)
    print("âœ… Agent æ­£å¸¸è¿è¡Œ:", json.dumps(result, ensure_ascii=False)[:200])
except Exception as e:
    print("âŒ Agent å¯åŠ¨æˆ–è¿è¡Œå¤±è´¥:", e)
    sys.exit(1)
EOF

      echo "=== âœ… æ£€æŸ¥å®Œæˆ ==="
